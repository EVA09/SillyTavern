
<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¯Šç–—æ—¥è®°</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap"
        rel="stylesheet"
    />
    <style>
        .yy-debug-panel-diary {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-width: 380px;
            max-height: 280px;
            overflow-y: auto;
            z-index: 999999;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            line-height: 1.4;
        }
        .yy-debug-panel-diary div {
            margin: 2px 0;
            word-break: break-all;
        }
        .yy-debug-panel-diary .yy-debug-title {
            color: #fff;
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #0f0;
            padding-bottom: 4px;
        }

        :root {
            --ink: #5a4635;
            --accent: #b48a60;
            --paper: #f5ecd7;
            --border: rgba(90, 70, 53, 0.35);
            --line: rgba(90, 70, 53, 0.2);
        }

        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Noto Serif SC', serif;
            color: var(--ink);
        }

        .yy-theme-medical-record {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 28px 70px 60px;
            background:
                    radial-gradient(600px 320px at 18% 12%, rgba(199, 162, 123, 0.14), transparent),
                    linear-gradient(180deg, #f8f1e4, #efe6d4);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
            clip-path: polygon(
                    0% 2%,
                    3% 1%,
                    6% 2%,
                    9% 0%,
                    100% 1%,
                    99% 8%,
                    100% 18%,
                    98% 30%,
                    100% 42%,
                    99% 58%,
                    100% 72%,
                    98% 84%,
                    100% 92%,
                    97% 98%,
                    0% 100%
            );
        }

        .yy-theme-medical-record::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                    repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.02) 0 2px, transparent 2px 4px),
                    repeating-linear-gradient(90deg, rgba(0, 0, 0, 0.015) 0 2px, transparent 2px 4px);
            mix-blend-mode: multiply;
            opacity: 0.3;
            pointer-events: none;
        }

        .yy-theme-medical-record::after {
            content: '';
            position: absolute;
            left: 22px;
            top: 0;
            bottom: 0;
            width: 18px;
            background: radial-gradient(circle at center, rgba(90, 70, 53, 0.45) 4px, transparent 5px);
            background-size: 18px 72px;
            background-repeat: repeat-y;
            opacity: 0.7;
            pointer-events: none;
        }

        .yy-content-separator {
            position: absolute;
            left: 52px;
            top: 18px;
            bottom: 18px;
            width: 1px;
            background: linear-gradient(to bottom, transparent, rgba(90, 70, 53, 0.18), transparent);
        }

        .yy-medical-header {
            text-align: center;
            margin-bottom: 18px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--border);
        }
        .yy-medical-title {
            margin: 0;
            font-weight: 700;
            font-size: 24px;
            letter-spacing: 1px;
        }
        .yy-medical-subtitle {
            font-size: 13px;
            color: rgba(90, 70, 53, 0.6);
            font-style: italic;
        }

        .yy-info-row {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--line);
            margin-bottom: 16px;
            font-size: 13px;
        }
        .yy-info-field {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .yy-info-label {
            font-weight: 600;
        }
        .yy-info-value {
            border-bottom: 1px dashed var(--line);
            padding: 0 6px;
            color: rgba(90, 70, 53, 0.75);
        }

        .yy-section-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--accent);
            margin: 18px 0 10px;
            padding-left: 10px;
            border-left: 3px solid var(--accent);
        }

        .yy-diagnosis-box,
        .yy-small-box {
            background: rgba(255, 255, 255, 0.45);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            font-size: 13px;
            line-height: 1.8;
            color: rgba(90, 70, 53, 0.85);
            max-height: 150px;
            overflow-y: auto;
        }
        .yy-small-box {
            font-size: 12px;
            height: 120px; /* å›ºå®šé«˜åº¦ */
            max-height: 120px;
        }

        .yy-two-column {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 14px;
        }

        .yy-medication-list {
            font-size: 12px;
            border: none; /* ç§»é™¤è¾¹æ¡† */
            border-radius: 0;
            background: transparent; /* é€æ˜èƒŒæ™¯ */
            padding: 0;
            line-height: 2;
        }
        .yy-medication-list .note-label {
            color: var(--accent);
            font-weight: 600;
        }

        .yy-events-accordion {
            margin-top: 18px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.35);
            overflow: hidden;
        }
        .yy-events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
        }
        .yy-events-header:hover {
            background: rgba(180, 138, 96, 0.18);
        }
        .yy-events-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
        }
        .yy-events-title::before {
            content: 'ğŸ“‹';
        }
        .yy-events-toggle {
            transition: transform 0.3s;
            color: var(--accent);
        }
        .yy-events-toggle.yy-expanded {
            transform: rotate(180deg);
        }
        .yy-events-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }
        .yy-events-content.yy-expanded {
            max-height: 220px;
            overflow-y: auto;
        }
        .yy-events-list {
            padding: 12px 16px;
            font-size: 12px;
            color: rgba(90, 70, 53, 0.8);
        }
        .yy-event-item {
            border-bottom: 1px dashed rgba(90, 70, 53, 0.18);
            padding: 6px 0 6px 14px;
            position: relative;
        }
        .yy-event-item::before {
            content: 'â–ª';
            position: absolute;
            left: 0;
            color: var(--accent);
        }
        .yy-event-empty {
            padding: 14px;
            text-align: center;
            font-style: italic;
            color: rgba(90, 70, 53, 0.6);
        }

        .yy-signature-area {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            margin-top: 20px;
            padding-top: 14px;
            border-top: 1px dashed var(--line);
            font-size: 12px;
        }
        .yy-signature-field {
            display: flex;
            gap: 6px;
        }
        .yy-signature-value {
            border-bottom: 1px solid var(--line);
            padding: 0 10px;
            min-width: 90px;
            text-align: center;
        }

        .yy-page-nav {
            position: absolute;
            right: 18px;
            bottom: 18px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .yy-page-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--ink);
            cursor: pointer;
            transition: all 0.3s;
            min-width: 74px;
        }
        .yy-page-btn:hover {
            background: rgba(180, 138, 96, 0.22);
            transform: translateY(-2px);
        }
        .yy-page-btn.yy-active {
            background: linear-gradient(135deg, #b48a60, #a67c52);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 6px 14px rgba(180, 138, 96, 0.35);
        }
        .yy-medical-record-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #6c5ce7, #5f4dd1);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 74px;
            border-color: transparent;
        }
        .yy-medical-record-btn:hover {
            background: linear-gradient(135deg, #7c6cf7, #6f5de1);
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(108, 92, 231, 0.35);
        }
        .yy-npc-list-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 74px;
            border-color: transparent;
        }
        .yy-npc-list-btn:hover {
            background: linear-gradient(135deg, #ff5e4c, #d04333);
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(231, 76, 60, 0.35);
        }

        /* å³ä¸Šè§’æŒ‰é’®ç»„ */
        .yy-top-buttons {
            position: absolute;
            top: 18px;
            right: 18px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .yy-top-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .yy-top-btn-npc {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        .yy-top-btn-npc:hover {
            background: linear-gradient(135deg, #ff5e4c, #d04333);
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(231, 76, 60, 0.4);
        }
        .yy-top-btn-medical {
            background: linear-gradient(135deg, #6c5ce7, #5f4dd1);
        }
        .yy-top-btn-medical:hover {
            background: linear-gradient(135deg, #7c6cf7, #6f5de1);
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(108, 92, 231, 0.4);
        }

        /* åˆå§‹åŒ–å¼¹çª—æ ·å¼ */
        .yy-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999999;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .yy-modal.yy-show {
            display: flex;
            opacity: 1;
        }
        .yy-modal-content {
            background: linear-gradient(180deg, #f8f1e4, #efe6d4);
            border: 2px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            max-width: 420px;
            width: 90%;
            padding: 0;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s;
            font-family: 'Noto Serif SC', serif;
        }
        .yy-modal.yy-show .yy-modal-content {
            transform: scale(1);
        }
        .yy-modal-content::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.02) 0 2px, transparent 2px 4px);
            border-radius: 8px;
            pointer-events: none;
            opacity: 0.3;
        }
        .yy-modal-header {
            padding: 20px 24px 16px;
            border-bottom: 2px dashed var(--border);
            text-align: center;
        }
        .yy-modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--ink);
            letter-spacing: 2px;
        }
        .yy-modal-body {
            padding: 24px;
            color: var(--ink);
            line-height: 1.8;
        }
        .yy-modal-body p {
            margin: 0 0 12px 0;
            font-size: 15px;
        }
        .yy-modal-note {
            margin-top: 20px;
            padding: 12px;
            background: rgba(180, 138, 96, 0.1);
            border-left: 3px solid var(--accent);
            border-radius: 4px;
        }
        .yy-modal-note small {
            font-size: 13px;
            color: var(--accent);
            opacity: 0.8;
        }
        /* è¾“å…¥æ¡†ç„¦ç‚¹æ ·å¼ */
        #yyFetishInput:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(180, 138, 96, 0.15);
        }
        .yy-modal-footer {
            padding: 16px 24px 20px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 2px dashed var(--border);
        }
        .yy-modal-btn {
            padding: 10px 24px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Serif SC', serif;
        }
        .yy-btn-cancel {
            background: rgba(255, 255, 255, 0.5);
            color: var(--ink);
        }
        .yy-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .yy-btn-confirm {
            background: linear-gradient(135deg, #b48a60, #a67c52);
            color: #fff;
            border-color: transparent;
        }
        .yy-btn-confirm:hover {
            background: linear-gradient(135deg, #c59a70, #b68c62);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(180, 138, 96, 0.4);
        }

        /* æ”»ç•¥è¿›åº¦é¢æ¿æ ·å¼ */
        .yy-strategy-section {
            margin-top: 24px;
            border-top: 2px dashed var(--border);
            padding-top: 16px;
        }
        .yy-strategy-toggle {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(180, 138, 96, 0.12), rgba(180, 138, 96, 0.08));
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            color: var(--ink);
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Serif SC', serif;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
        }
        .yy-strategy-toggle .yy-toggle-icon,
        .yy-strategy-toggle .yy-toggle-text {
            flex-shrink: 0;
        }
        .yy-current-stage {
            margin-left: auto;
            font-size: 13px;
            padding: 3px 10px;
            border-radius: 12px;
            background: rgba(180, 138, 96, 0.15);
            color: var(--accent);
            font-weight: 500;
        }
        .yy-strategy-toggle:hover {
            background: linear-gradient(135deg, rgba(180, 138, 96, 0.18), rgba(180, 138, 96, 0.12));
            border-color: var(--accent);
        }
        .yy-toggle-icon {
            transition: transform 0.3s;
            font-size: 12px;
        }
        .yy-strategy-toggle.yy-expanded .yy-toggle-icon {
            transform: rotate(180deg);
        }
        .yy-strategy-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            margin-top: 12px;
        }
        .yy-strategy-panel.yy-expanded {
            max-height: 500px;
        }
        .yy-current-stage.yy-stage-1 {
            background: rgba(180, 180, 180, 0.3);
            color: #666;
        }
        .yy-current-stage.yy-stage-2 {
            background: rgba(240, 200, 100, 0.25);
            color: #a67c2e;
        }
        .yy-current-stage.yy-stage-3 {
            background: rgba(240, 140, 80, 0.3);
            color: #d97943;
        }
        .yy-current-stage.yy-stage-4 {
            background: rgba(100, 180, 120, 0.3);
            color: #2d8659;
        }
        .yy-events-container {
            padding: 4px;
            max-height: 460px;
            overflow-y: auto;
        }
        .yy-event-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.6);
            border-left: 3px solid var(--accent);
            border-radius: 3px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--ink);
        }
        .yy-event-key {
            font-size: 11px;
            color: var(--accent);
            opacity: 0.6;
            margin-right: 8px;
            font-family: 'Courier New', monospace;
        }
        .yy-loading {
            text-align: center;
            padding: 16px;
            color: var(--accent);
            opacity: 0.6;
            font-size: 13px;
        }

        .yy-page-container {
            position: relative;
            perspective: 1400px;
            min-height: 520px;
        }
        .yy-page-content {
            position: absolute;
            inset: 0;
            opacity: 0;
            pointer-events: none;
            transform-origin: left center;
            transform: rotateY(-80deg) translateZ(-40px);
            filter: blur(2px);
            transition:
                    transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                    opacity 0.5s ease,
                    filter 0.5s ease;
        }
        .yy-page-content.yy-active {
            position: relative;
            opacity: 1;
            pointer-events: auto;
            transform: rotateY(0deg) translateZ(0);
            filter: blur(0);
        }

        .yy-cover-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition:
                    opacity 0.5s ease,
                    visibility 0.5s ease;
        }
        .yy-cover-overlay.yy-hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        #yy-mainContent {
            transition: opacity 0.5s ease;
        }
        #yy-mainContent.yy-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .yy-cover-container {
            position: relative;
            padding: 46px 54px;
            max-width: 520px;
            text-align: center;
            border-radius: 18px;
            background:
                    radial-gradient(640px 320px at 18% 10%, rgba(199, 162, 123, 0.14), transparent),
                    linear-gradient(180deg, #f8f1e4, #efe6d4);
            border: 2px solid rgba(90, 70, 53, 0.32);
            box-shadow: 0 18px 48px rgba(0, 0, 0, 0.18);
        }
        .yy-cover-title {
            font-size: 30px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        .yy-cover-subtitle {
            font-size: 15px;
            color: rgba(90, 70, 53, 0.68);
            margin-bottom: 28px;
        }
        .yy-cover-description {
            font-size: 13px;
            color: rgba(90, 70, 53, 0.78);
            line-height: 1.9;
            margin-bottom: 34px;
        }
        .yy-cover-button {
            padding: 14px 36px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #b48a60, #a67c52);
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 24px rgba(180, 138, 96, 0.45);
            transition: all 0.3s;
            font-family: inherit;
        }
        .yy-cover-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 28px rgba(180, 138, 96, 0.5);
        }
        .yy-cover-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .yy-loading-text {
            margin-top: 16px;
            font-size: 13px;
            color: var(--accent);
            display: none;
        }

        @media (max-width: 520px) {
            .yy-theme-medical-record {
                padding: 20px 18px 70px 46px;
            }
            .yy-top-buttons {
                top: 12px;
                right: 12px;
                flex-direction: column;
                gap: 6px;
            }
            .yy-top-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
            .yy-page-nav {
                right: 12px;
                bottom: 16px;
            }
            .yy-two-column {
                grid-template-columns: 1fr;
            }
            .yy-signature-area {
                flex-direction: column;
                align-items: flex-start;
            }
            .yy-cover-container {
                padding: 36px 26px;
            }
        }
    </style>
</head>
<body>
<!-- å°é¢é®ç½©å±‚ -->
<div class="yy-cover-overlay" id="yy-coverOverlay">
    <div class="yy-cover-container">
        <h1 class="yy-cover-title">å¿ƒç†å’¨è¯¢è¯Šç–—è®°å½•</h1>
        <p class="yy-cover-subtitle">æ¸©çŸ¥å¤ Â· æ€§ç˜¾åº·å¤æ²»ç–—æ¡£æ¡ˆ</p>
        <div class="yy-cover-description">
            è¿™æ˜¯ä¸€ä»½æ¥è‡ªå¸‚å¿ƒç†å¥åº·ä¸­å¿ƒçš„å®Œæ•´æ²»ç–—æ¡£æ¡ˆã€‚<br />
            æ¡£æ¡ˆè®°å½•äº†æ‚£è€…æ¸©çŸ¥å¤åœ¨2018å¹´è‡³2019å¹´é—´çš„åº·å¤æ²»ç–—è¿‡ç¨‹ã€‚<br /><br />
            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œæ ¹æ®ä½ çš„åå¥½å®šåˆ¶ä¸“å±çš„æ”»ç•¥çº¿ç´¢ã€‚<br /><br />
            <span style="font-size: 12px; color: rgba(90, 70, 53, 0.6); font-style: italic;">
            ğŸ’¡ æ„Ÿè°¢ Maybe å¤§ä½¬å¸®æˆ‘ä¿®å¤çŠ¶æ€æ ï¼Œè¯·å¼€å¯å°ç™½Xæ’ä»¶æ¸²æŸ“æ¸¸ç©ã€‚
          </span>
        </div>
        <button class="yy-cover-button" id="yy-initButton">ğŸ”“ å¼€å§‹å®šåˆ¶æ”»ç•¥ç³»ç»Ÿ</button>
        <div class="yy-loading-text" id="yy-loadingText">æ­£åœ¨ç”Ÿæˆä¸­...</div>
    </div>
</div>

<!-- åˆå§‹åŒ–ç¡®è®¤å¼¹çª—ï¼ˆå¿…é¡»åœ¨é¡¶å±‚ï¼‰ -->
<div class="yy-modal" id="yyInitModal">
    <div class="yy-modal-content">
        <div class="yy-modal-header">
            <h3>è¯Šç–—æ—¥è®°ç³»ç»Ÿ - å®šåˆ¶æ”»ç•¥</h3>
        </div>
        <div class="yy-modal-body">
            <p style="margin-bottom: 12px; font-size: 14px; line-height: 1.6">
                è¯·è¾“å…¥ä½ çš„<strong>æ€§ç™–åå¥½</strong>ï¼Œç”¨äºå®šåˆ¶ä¸“å±æ”»ç•¥çº¿ç´¢ï¼š
            </p>

            <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
            <textarea
                id="yyFetishInput"
                placeholder="ä¾‹å¦‚ï¼šè¶³éƒ¨ã€ä¸è¢œã€åˆ¶æœã€æ¸©æŸ”æ”»ç•¥ã€å…¬å…±åœºåˆç­‰&#10;å¯ä»¥è¾“å…¥å¤šä¸ªï¼Œç”¨é€—å·åˆ†éš”"
                style="
              width: 100%;
              min-height: 100px;
              padding: 12px;
              border: 2px solid rgba(90, 70, 53, 0.2);
              border-radius: 6px;
              font-size: 14px;
              font-family: inherit;
              line-height: 1.6;
              resize: vertical;
              background: #fff;
              transition: border-color 0.3s;
              box-sizing: border-box;
            "
            ></textarea>

            <div class="yy-modal-note" style="margin-top: 16px">
                <small>ğŸ’¡ æç¤ºï¼šè¾“å…¥å†…å®¹è¶Šå…·ä½“ï¼Œç”Ÿæˆçš„æ”»ç•¥çº¿ç´¢è¶Šç²¾å‡†</small>
            </div>
            <div class="yy-modal-note">
                <small>â±ï¸ åˆå§‹åŒ–è¿‡ç¨‹éœ€è¦ 30-120 ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…</small>
            </div>
        </div>
        <div class="yy-modal-footer">
            <button class="yy-modal-btn yy-btn-cancel" id="yyInitCancel">ç¨å</button>
            <button class="yy-modal-btn yy-btn-confirm" id="yyInitConfirm">å¼€å§‹ç”Ÿæˆ</button>
        </div>
    </div>
</div>

<!-- NPCç”Ÿæˆå¼¹çª— -->
<div class="yy-modal" id="yyNPCGenModal">
    <div class="yy-modal-content" style="max-width: 600px;">
        <div class="yy-modal-header">
            <h3>ğŸ­ ç”Ÿæˆæ–°NPC</h3>
        </div>
        <div class="yy-modal-body">
            <p style="margin-bottom: 12px; font-size: 14px; line-height: 1.6">
                è¯·è¾“å…¥NPCçš„åŸºæœ¬è®¾å®šï¼ŒAIå°†è‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„NPCæ•°æ®ï¼š
            </p>

            <!-- æ€§ç™–è¾“å…¥æ¡† -->
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--accent); font-size: 13px;">
                æ€§ç™–æ–¹å‘ï¼ˆå¯é€‰ï¼Œç•™ç©ºAIéšæœºï¼‰
            </label>
            <textarea
                id="yyNPCFetishInput"
                placeholder="ä¾‹å¦‚ï¼šè¶³æ§ã€ä¸è¢œã€åŠå…¬å¼€åœºåˆ&#10;å¯è¾“å…¥1-3ä¸ªï¼Œç”¨é€—å·åˆ†éš”"
                style="
              width: 100%;
              min-height: 80px;
              padding: 12px;
              border: 2px solid rgba(90, 70, 53, 0.2);
              border-radius: 6px;
              font-size: 14px;
              font-family: inherit;
              line-height: 1.6;
              resize: vertical;
              background: #fff;
              transition: border-color 0.3s;
              box-sizing: border-box;
              margin-bottom: 16px;
            "
            ></textarea>

            <!-- èº«ä»½è¾“å…¥æ¡† -->
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--accent); font-size: 13px;">
                NPCèº«ä»½/èŒä¸šï¼ˆå¿…å¡«ï¼‰
            </label>
            <input
                id="yyNPCIdentityInput"
                type="text"
                placeholder="ä¾‹å¦‚ï¼šå­¦æ ¡é‡Œçš„å­¦ç”Ÿã€å›¾ä¹¦é¦†ç®¡ç†å‘˜ã€å¥èº«æˆ¿æ•™ç»ƒã€é‚»å±…"
                value="å­¦æ ¡é‡Œçš„å­¦ç”Ÿ"
                style="
              width: 100%;
              padding: 12px;
              border: 2px solid rgba(90, 70, 53, 0.2);
              border-radius: 6px;
              font-size: 14px;
              font-family: inherit;
              background: #fff;
              transition: border-color 0.3s;
              box-sizing: border-box;
            "
            />

            <div class="yy-modal-note" style="margin-top: 16px">
                <small>ğŸ’¡ æç¤ºï¼šAIç”Ÿæˆéœ€è¦60-120ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…</small>
            </div>
            <div class="yy-modal-note">
                <small>âš ï¸ ç”Ÿæˆçš„NPCå°†ä¼šæ·»åŠ åˆ°ä¸–ç•Œä¹¦å’Œå˜é‡ä¸­ï¼Œå¯åœ¨"è§’è‰²åˆ—è¡¨"æŸ¥çœ‹</small>
            </div>
        </div>
        <div class="yy-modal-footer">
            <button class="yy-modal-btn yy-btn-cancel" id="yyNPCGenCancel">å–æ¶ˆ</button>
            <button class="yy-modal-btn yy-btn-confirm" id="yyNPCGenConfirm">å¼€å§‹ç”Ÿæˆ</button>
        </div>
    </div>
</div>

<section class="yy-theme-medical-record yy-hidden" id="yy-mainContent">
    <div class="yy-content-separator"></div>

    <!-- å³ä¸Šè§’è§’è‰²åˆ—è¡¨æŒ‰é’® -->
    <div class="yy-top-buttons">
        <button class="yy-top-btn yy-top-btn-npc" id="yy-npcListBtn">ğŸ‘¥ è§’è‰²åˆ—è¡¨</button>
    </div>

    <div class="yy-medical-header">
        <h1 class="yy-medical-title">å¿ƒç†å’¨è¯¢è¯Šç–—è®°å½•</h1>
        <div class="yy-medical-subtitle">Psychological Consultation Record</div>
    </div>

    <div class="yy-page-nav">
        <button class="yy-medical-record-btn" id="yy-medicalRecordBtn" style="display: none;">ğŸ“‹ æ¢ç´¢ç—…ä¾‹</button>
        <button class="yy-page-btn yy-active" data-page="1">â— çº¿ç´¢ä¸€</button>
        <button class="yy-page-btn" data-page="2">â—‹ çº¿ç´¢äºŒ</button>
        <button class="yy-page-btn" data-page="3">â—‹ çº¿ç´¢ä¸‰</button>
    </div>

    <div class="yy-page-container">
        <div class="yy-page-content yy-active" data-page-content="1">
            <div class="yy-info-row">
                <div class="yy-info-field">
                    <span class="yy-info-label">æ—¥æœŸ:</span><span class="yy-info-value">2018å¹´9æœˆ</span>
                </div>
                <div class="yy-info-field">
                    <span class="yy-info-label">å§“å:</span><span class="yy-info-value">æ¸©çŸ¥å¤</span>
                </div>
                <div class="yy-info-field">
                    <span class="yy-info-label">åŒ»é™¢:</span><span class="yy-info-value">å¸‚å¿ƒç†å¥åº·ä¸­å¿ƒ</span>
                </div>
            </div>

            <div class="yy-section-title">è§‚å¯Ÿè®°å½•</div>
            <div class="yy-diagnosis-box">è°ˆåŠè¶³éƒ¨è§¦ç¢°æ—¶ï¼Œæ‚£è€…ä¼šç«‹åˆ»äº¤å‰åŒè‡‚ã€ç§»å¼€è§†çº¿å¹¶è¯•å›¾ç»“æŸè¯é¢˜ï¼Œè¯­é€Ÿæ˜æ˜¾åŠ å¿«ã€‚</div>

            <div class="yy-two-column">
                <div>
                    <div class="yy-section-title">æ‚£è€…è¡¨è¿°</div>
                    <div class="yy-small-box">â€œé‚£æ—¶å€™â€¦â€¦æˆ‘å°±åƒç€äº†é­”ä¸€æ ·åœä¸ä¸‹æ¥ã€‚â€ï¼ˆå£°éŸ³å‹ä½ï¼Œæ‰‹æŒ‡ç»ç´§è¡£è§’ï¼‰</div>
                </div>
                <div>
                    <div class="yy-section-title">è¡Œä¸ºæ¨¡å¼</div>
                    <div class="yy-small-box">åœ¨å®¶ä¸­ä¼šä¸‹æ„è¯†æ‘¸é”ç€çš„æŠ½å±‰ï¼Œä½†ç«‹åˆ»æ”¶å›æ‰‹ï¼›é¢‘ç¹ç”¨å†·æ°´æ´—è„šä»¥é™ä½è§¦è§‰æ•æ„Ÿã€‚</div>
                </div>
            </div>

            <div class="yy-section-title">æ²»ç–—å¸ˆå¤‡æ³¨</div>
            <div class="yy-medication-list">
                <span>â€¢</span><span>å»ºè®®ï¼šå¸®åŠ©æ‚£è€…åŒºåˆ†â€œæ¬²æœ›å­˜åœ¨â€ä¸â€œå¤±æ§è¡Œä¸ºâ€ä¹‹é—´çš„å·®å¼‚ï¼Œå¹¶å»ºç«‹æŒæ§æ„Ÿã€‚</span><br /><span
            >â€¢</span
            ><span>å…³æ³¨ï¼šè¶³éƒ¨è§¦è§‰ä¸ºé«˜æ•è§¦å‘ç‚¹ï¼Œéœ€é¿å…â€œå¤±è´¥ = åŸå½¢æ¯•éœ²â€çš„æç«¯è®¤çŸ¥ã€‚</span>
            </div>

            <div class="yy-signature-area">
                <div class="yy-signature-field"><span>æ²»ç–—å¸ˆ:</span><span class="yy-signature-value">æåŒ»ç”Ÿ</span></div>
                <div class="yy-signature-field">
                    <span>è®°å½•æ—¥æœŸ:</span><span class="yy-signature-value">2018/09/15</span>
                </div>
            </div>
        </div>

        <div class="yy-page-content" data-page-content="2">
            <div class="yy-info-row">
                <div class="yy-info-field">
                    <span class="yy-info-label">æ—¥æœŸ:</span><span class="yy-info-value">2018å¹´10æœˆ</span>
                </div>
                <div class="yy-info-field">
                    <span class="yy-info-label">å§“å:</span><span class="yy-info-value">æ¸©çŸ¥å¤</span>
                </div>
                <div class="yy-info-field">
                    <span class="yy-info-label">åŒ»é™¢:</span><span class="yy-info-value">å¸‚å¿ƒç†å¥åº·ä¸­å¿ƒ</span>
                </div>
            </div>

            <div class="yy-section-title">è§‚å¯Ÿè®°å½•</div>
            <div class="yy-diagnosis-box">è®¨è®ºèƒ¸éƒ¨ç›¸å…³åˆºæ¿€æ—¶ï¼Œä¼šæœ¬èƒ½åœ°æŠ±è‡‚æ©æŠ¤ï¼Œè¯­æ°”è¿Ÿç–‘ï¼›æ¢è¡£æ—¶æ˜æ˜¾æé˜²è´´èº«æè´¨ã€‚</div>

            <div class="yy-two-column">
                <div>
                    <div class="yy-section-title">æ‚£è€…è¡¨è¿°</div>
                    <div class="yy-small-box">â€œå°±è¿ç©¿è¡£æœéƒ½ä¼šâ€¦â€¦å¥½åƒåˆå›åˆ°ä»å‰ï¼Œæˆ‘ä¸æƒ³å†ä½“éªŒäº†ã€‚â€ï¼ˆç›®å…‰é£˜å¿½ï¼Œå‘¼å¸å˜æµ…ï¼‰</div>
                </div>
                <div>
                    <div class="yy-section-title">è¡Œä¸ºæ¨¡å¼</div>
                    <div class="yy-small-box">å€¾å‘é€‰æ‹©é«˜é¢†ã€å®½æ¾è¡£ç‰©ï¼›åœ¨é•œå­å‰æ£€æŸ¥è¡£ç‰©ä¸çš®è‚¤çš„â€œå®‰å…¨è·ç¦»â€åæ‰æ•¢å‡ºé—¨ã€‚</div>
                </div>
            </div>

            <div class="yy-section-title">æ²»ç–—å¸ˆå¤‡æ³¨</div>
            <div class="yy-medication-list">
                <span>â€¢</span><span>å»ºè®®ï¼šä»¥æ¸è¿›å¼è„±æ•è®­ç»ƒé™ä½â€œæ¥è§¦ = å¤±æ§â€çš„è”æƒ³å¼ºåº¦ã€‚</span><br /><span>â€¢</span
            ><span>å…³æ³¨ï¼šè‡ªè´£æƒ…ç»ªå¼ºçƒˆï¼Œä¼šé€šè¿‡å¡«æ»¡è¡Œç¨‹æ¥é€ƒé¿èº«ä½“æ„Ÿå—ã€‚</span>
            </div>

            <div class="yy-signature-area">
                <div class="yy-signature-field"><span>æ²»ç–—å¸ˆ:</span><span class="yy-signature-value">æåŒ»ç”Ÿ</span></div>
                <div class="yy-signature-field">
                    <span>è®°å½•æ—¥æœŸ:</span><span class="yy-signature-value">2018/10/22</span>
                </div>
            </div>
        </div>

        <div class="yy-page-content" data-page-content="3">
            <div class="yy-info-row">
                <div class="yy-info-field">
                    <span class="yy-info-label">æ—¥æœŸ:</span><span class="yy-info-value">2019å¹´1æœˆ</span>
                </div>
                <div class="yy-info-field">
                    <span class="yy-info-label">å§“å:</span><span class="yy-info-value">æ¸©çŸ¥å¤</span>
                </div>
                <div class="yy-info-field">
                    <span class="yy-info-label">åŒ»é™¢:</span><span class="yy-info-value">å¸‚å¿ƒç†å¥åº·ä¸­å¿ƒ</span>
                </div>
            </div>

            <div class="yy-section-title">è§‚å¯Ÿè®°å½•</div>
            <div class="yy-diagnosis-box">å›å¿†å…¬å…±åœºåˆçš„å¤±æ§ç»å†ä¼šè§¦å‘è„¸éƒ¨æ³›çº¢ã€è§†çº¿é€ƒé¿åŠæ‰‹æŒ‡å‘æŠ–ï¼Œå¸¸ä¼´éšå½»å¤œå¤±çœ ã€‚</div>

            <div class="yy-two-column">
                <div>
                    <div class="yy-section-title">æ‚£è€…è¡¨è¿°</div>
                    <div class="yy-small-box">â€œåœ¨å›¾ä¹¦é¦†é‚£æ¬¡â€¦â€¦æˆ‘åˆ°ç°åœ¨éƒ½æ²¡åŠæ³•åŸè°…è‡ªå·±ã€‚â€ï¼ˆåŒè‚©è½»é¢¤ï¼Œå£°éŸ³å‘æŠ–ï¼‰</div>
                </div>
                <div>
                    <div class="yy-section-title">è¡Œä¸ºæ¨¡å¼</div>
                    <div class="yy-small-box">é¿å…äººç¾¤å¯†é›†åœºåˆï¼Œè§„åˆ’å‡ºè¡Œè·¯çº¿æ—¶åˆ»æ„ç»•å¼€æ›¾å¤±æ§çš„åœ°ç‚¹ã€‚</div>
                </div>
            </div>

            <div class="yy-section-title">æ²»ç–—å¸ˆå¤‡æ³¨</div>
            <div class="yy-medication-list">
                <span>â€¢</span><span>å»ºè®®ï¼šè®©æ‚£è€…ç†è§£ç¾è€»æ˜¯å¤åŸè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå»ºç«‹æƒ…ç»ªç–å¯¼æ–¹æ¡ˆã€‚</span><br /><span>â€¢</span
            ><span>å…³æ³¨ï¼šå…¬å…±åœºåˆè§¦å‘ä¼šå¼ºåŒ–â€œæˆ‘ä¸é…äº²å¯†å…³ç³»â€çš„ä¿¡å¿µã€‚</span>
            </div>

            <div class="yy-signature-area">
                <div class="yy-signature-field"><span>æ²»ç–—å¸ˆ:</span><span class="yy-signature-value">æåŒ»ç”Ÿ</span></div>
                <div class="yy-signature-field">
                    <span>è®°å½•æ—¥æœŸ:</span><span class="yy-signature-value">2019/01/12</span>
                </div>
            </div>
        </div>
    </div>

    <!-- æ”»ç•¥è¿›åº¦é¢æ¿ -->
    <div class="yy-strategy-section">
        <button class="yy-strategy-toggle" id="yyStrategyToggle">
            <span class="yy-toggle-icon">â–¼</span>
            <span class="yy-toggle-text">æ”»ç•¥è¿›åº¦</span>
            <span class="yy-current-stage" id="yyCurrentStage">åŠ è½½ä¸­...</span>
        </button>

        <div class="yy-strategy-panel" id="yyStrategyPanel">
            <!-- å½“å‰çº¿ç´¢çš„äº‹ä»¶åˆ—è¡¨ -->
            <div class="yy-events-container" id="yyEventsContainer">
                <div class="yy-loading">æ­£åœ¨åŠ è½½äº‹ä»¶åˆ—è¡¨...</div>
            </div>
        </div>
    </div>
</section>

<script>
  function showPage(page) {
    var contents = document.querySelectorAll('.yy-page-content');
    var buttons = document.querySelectorAll('.yy-page-btn');
    var labels = ['ä¸€', 'äºŒ', 'ä¸‰'];

    for (var i = 0; i < contents.length; i++) {
      if (Number(contents[i].dataset.pageContent) === page) {
        contents[i].classList.add('yy-active');
      } else {
        contents[i].classList.remove('yy-active');
      }
    }

    for (var j = 0; j < buttons.length; j++) {
      if (Number(buttons[j].dataset.page) === page) {
        buttons[j].classList.add('yy-active');
        buttons[j].textContent = 'â— çº¿ç´¢' + labels[j];
      } else {
        buttons[j].classList.remove('yy-active');
        buttons[j].textContent = 'â—‹ çº¿ç´¢' + labels[j];
      }
    }

    // æ›´æ–°æ”»ç•¥è¿›åº¦é¡µ
    currentStrategyPage = page;
    updateCurrentStage(); // æ›´æ–°é˜¶æ®µæ ‡ç­¾

    // å¦‚æœæ”»ç•¥é¢æ¿æ˜¯å±•å¼€çš„ï¼Œé‡æ–°åŠ è½½äº‹ä»¶
    var panel = document.getElementById('yyStrategyPanel');
    if (panel && panel.classList.contains('yy-expanded')) {
      loadCurrentClueEvents();
    }
  }

  // ä»SillyTavernå˜é‡è¯»å–è¯Šç–—æ—¥è®°å†…å®¹
  async function loadDiaryFromVariables() {
    // æ£€æŸ¥STscriptå‡½æ•°æ˜¯å¦å¯ç”¨
    if (typeof STscript !== 'function') {
      console.error('[è¯Šç–—æ—¥è®°] STscriptå‡½æ•°ä¸å¯ç”¨');
      return;
    }

    console.log('[è¯Šç–—æ—¥è®°] å¼€å§‹åŠ è½½å˜é‡...');

    const fields = [
      { key: 'è§‚å¯Ÿè®°å½•', selectorIndex: 0 }, // ç¬¬1ä¸ª .yy-diagnosis-box
      { key: 'æ‚£è€…è¡¨è¿°', selectorIndex: 0 }, // ç¬¬1ä¸ª .yy-small-box
      { key: 'è¡Œä¸ºæ¨¡å¼', selectorIndex: 1 }, // ç¬¬2ä¸ª .yy-small-box
      { key: 'æ²»ç–—å¸ˆå¤‡æ³¨', isNotes: true }, // .yy-medication-list é‡Œçš„ span
    ];

    for (let i = 1; i <= 3; i++) {
      const pageEl = document.querySelector(`.yy-page-content[data-page-content="${i}"]`);
      if (!pageEl) continue;

      for (const field of fields) {
        const varKey = `è¯Šç–—æ—¥è®°.çº¿ç´¢${i}.${field.key}`;

        try {
          const valueRaw = await STscript(`/getvar ${varKey}`);
          let value = valueRaw;

          // æå–pipeå­—æ®µ
          if (typeof valueRaw === 'object' && valueRaw !== null) {
            if (valueRaw.pipe !== undefined) {
              value = valueRaw.pipe;
            } else {
              // å¦‚æœæ˜¯å¯¹è±¡ä½†æ²¡æœ‰pipeå­—æ®µï¼Œè¯´æ˜å˜é‡ä¸å­˜åœ¨
              value = '';
            }
          }

          const content = String(value || '').trim();

          if (content) {
            let targetEl;

            if (field.key === 'è§‚å¯Ÿè®°å½•') {
              targetEl = pageEl.querySelector('.yy-diagnosis-box');
            } else if (field.key === 'æ‚£è€…è¡¨è¿°') {
              targetEl = pageEl.querySelectorAll('.yy-small-box')[0];
            } else if (field.key === 'è¡Œä¸ºæ¨¡å¼') {
              targetEl = pageEl.querySelectorAll('.yy-small-box')[1];
            } else if (field.isNotes) {
              // æ²»ç–—å¸ˆå¤‡æ³¨ï¼šä½¿ç”¨innerHTMLæ”¯æŒHTMLæ ‡ç­¾
              targetEl = pageEl.querySelector('.yy-medication-list');
            }

            if (targetEl) {
              if (field.isNotes) {
                targetEl.innerHTML = content; // æ”¯æŒHTML
                console.log(`[è¯Šç–—æ—¥è®°] âœ… çº¿ç´¢${i} ${field.key}: å·²æ›´æ–°ï¼ˆHTMLï¼‰`);
              } else {
                targetEl.textContent = content; // çº¯æ–‡æœ¬
                console.log(`[è¯Šç–—æ—¥è®°] âœ… çº¿ç´¢${i} ${field.key}: ${content.length}å­—`);
              }
            }
          } else {
            console.warn(`[è¯Šç–—æ—¥è®°] âš ï¸ çº¿ç´¢${i} ${field.key}: ä¸ºç©º`);
            // ä¸ºç©ºæ—¶å¼¹å‡ºtoastrè­¦å‘Š
            if (window.toastr) {
              window.toastr.warning(
                `çº¿ç´¢${i} çš„ "${field.key}" å­—æ®µä¸ºç©ºï¼Œå¯èƒ½æ˜¯AIç”Ÿæˆæ—¶æ ‡ç­¾æœªæ­£ç¡®é—­åˆã€‚è¯·æ£€æŸ¥åˆå§‹åŒ–è„šæœ¬çš„AIè¾“å‡ºã€‚`,
                'è¯Šç–—æ—¥è®°å­—æ®µç¼ºå¤±',
                { timeOut: 8000 },
              );
            }
          }
        } catch (e) {
          console.error(`[è¯Šç–—æ—¥è®°] âŒ è¯»å–${varKey}å¤±è´¥:`, e);
        }
      }
    }

    console.log('[è¯Šç–—æ—¥è®°] å˜é‡åŠ è½½å®Œæˆ');
  }

  // åˆå§‹åŒ–æŒ‰é’®ç‚¹å‡»å¤„ç†
  async function handleInitialize() {
    const button = document.getElementById('yy-initButton');
    const loadingText = document.getElementById('yy-loadingText');

    // è¯»å–ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬
    const fetishInput = document.getElementById('yyFetishInput').value.trim();

    if (!fetishInput) {
      window.toastr && window.toastr.warning('è¯·è¾“å…¥ä½ çš„æ€§ç™–åå¥½å†å¼€å§‹ç”Ÿæˆ');
      return;
    }

    console.log('[åˆå§‹åŒ–] ç”¨æˆ·è¾“å…¥:', fetishInput);

    button.disabled = true;
    loadingText.style.display = 'block';

    try {
      // æ£€æŸ¥STscriptå‡½æ•°æ˜¯å¦å¯ç”¨
      if (typeof STscript !== 'function') {
        throw new Error('STscriptå‡½æ•°ä¸å¯ç”¨,è¯·ç¡®ä¿åœ¨å°ç™½Xæ¨¡æ¿ç¯å¢ƒä¸­è¿è¡Œ');
      }

      // ç¬¬ä¸€æ­¥ï¼šè®¾ç½®ç”¨æˆ·åå¥½å˜é‡
      console.log('[åˆå§‹åŒ–] 1/2 è®¾ç½®ç”¨æˆ·åå¥½å˜é‡...');
      await STscript(`/setvar key=ç”¨æˆ·æ€§ç™– ${fetishInput}`);

      // ç¬¬äºŒæ­¥ï¼šè°ƒç”¨åˆå§‹åŒ–è„šæœ¬
      console.log('[åˆå§‹åŒ–] 2/2 è°ƒç”¨åˆå§‹åŒ–è„šæœ¬...');

      // æ£€æŸ¥å°ç™½Xå…¨å±€å¯¹è±¡
      console.log('[åˆå§‹åŒ–] æ£€æŸ¥ç¯å¢ƒ - window.xb:', typeof window.xb);
      console.log('[åˆå§‹åŒ–] æ£€æŸ¥ç¯å¢ƒ - window.xbqte:', typeof window.xbqte);

      let scriptTriggered = false;

      // æ–¹æ³•1ï¼šä½¿ç”¨å°ç™½Xçš„å…¨å±€å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (typeof window.xbqte === 'function') {
        console.log('[åˆå§‹åŒ–] ä½¿ç”¨ window.xbqte() è°ƒç”¨...');
        try {
          await window.xbqte('è¯Šç–—æ—¥è®°');
          scriptTriggered = true;
          console.log('[åˆå§‹åŒ–] xbqte() è°ƒç”¨æˆåŠŸ');
        } catch (e) {
          console.error('[åˆå§‹åŒ–] xbqte() è°ƒç”¨å¤±è´¥:', e);
        }
      }

      // æ–¹æ³•2ï¼šé€šè¿‡executeSlashCommandsWithOptionsè°ƒç”¨ï¼ˆä½œä¸ºèŠå¤©æ¶ˆæ¯ï¼‰
      if (!scriptTriggered) {
        console.log('[åˆå§‹åŒ–] å°è¯•é€šè¿‡ executeSlash + è‡ªåŠ¨å‘é€...');
        try {
          // æ·»åŠ è¶…æ—¶ä¿æŠ¤
          const executePromise = STscript('/xbqte è¯Šç–—æ—¥è®°', {
            handleExecutionErrors: false,
            abortSignal: null,
          });

          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('executeSlash è¶…æ—¶ï¼ˆ5ç§’ï¼‰')), 5000),
          );

          console.log('[åˆå§‹åŒ–] ç­‰å¾… executeSlash è¿”å›...');
          const result = await Promise.race([executePromise, timeoutPromise]);

          console.log('[åˆå§‹åŒ–] executeSlash è¿”å›æˆåŠŸ:', result);
          console.log('[åˆå§‹åŒ–] è¿”å›ç±»å‹:', typeof result);
          console.log('[åˆå§‹åŒ–] è¿”å›å†…å®¹:', JSON.stringify(result));

          // æ£€æŸ¥è¿”å›ç»“æœ
          if (result && typeof result === 'object') {
            if (result.pipe && result.pipe.includes('é”™è¯¯')) {
              console.error('[åˆå§‹åŒ–] executeSlash è¿”å›é”™è¯¯:', result.pipe);
              throw new Error(result.pipe);
            } else {
              console.log('[åˆå§‹åŒ–] executeSlash æ‰§è¡ŒæˆåŠŸï¼Œpipe:', result.pipe);
              scriptTriggered = true;
            }
          } else {
            console.log('[åˆå§‹åŒ–] executeSlash è¿”å›äº†éå¯¹è±¡ç»“æœï¼Œå‡å®šæˆåŠŸ');
            scriptTriggered = true;
          }
        } catch (e) {
          console.log('[åˆå§‹åŒ–] executeSlash æœªç«‹å³è¿”å›ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼Œ/xbqte æ˜¯å¼‚æ­¥å‘½ä»¤ï¼‰');
          // ä¸è¦é˜»æ­¢åç»­æ–¹æ³•å°è¯•
        }
      }

      // æ–¹æ³•3ï¼šå°è¯•é€šè¿‡èŠå¤©è¾“å…¥æ¡†æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥
      if (!scriptTriggered) {
        console.log('[åˆå§‹åŒ–] å°è¯•é€šè¿‡èŠå¤©æ¡†æ¨¡æ‹Ÿè¾“å…¥...');
        const textarea = document.getElementById('send_textarea');
        const sendButton = document.getElementById('send_but');

        console.log('[åˆå§‹åŒ–] textarea å…ƒç´ :', textarea ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
        console.log('[åˆå§‹åŒ–] sendButton å…ƒç´ :', sendButton ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');

        if (textarea && sendButton) {
          console.log('[åˆå§‹åŒ–] å¼€å§‹æ¨¡æ‹ŸèŠå¤©æ¡†è¾“å…¥...');
          const originalValue = textarea.value;
          textarea.value = '/xbqte è¯Šç–—æ—¥è®°';

          // è§¦å‘ input äº‹ä»¶
          textarea.dispatchEvent(new Event('input', { bubbles: true }));
          console.log('[åˆå§‹åŒ–] å·²è®¾ç½® textarea å†…å®¹å¹¶è§¦å‘ input äº‹ä»¶');

          // ç­‰å¾…ä¸€å¸§
          await new Promise(resolve => setTimeout(resolve, 50));

          // ç‚¹å‡»å‘é€æŒ‰é’®
          console.log('[åˆå§‹åŒ–] å‡†å¤‡ç‚¹å‡»å‘é€æŒ‰é’®...');
          sendButton.click();
          console.log('[åˆå§‹åŒ–] âœ… å‘½ä»¤å·²é€šè¿‡èŠå¤©æ¡†å‘é€');
          scriptTriggered = true;

          // æ¢å¤åŸå€¼
          setTimeout(() => {
            textarea.value = originalValue;
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            console.log('[åˆå§‹åŒ–] å·²æ¢å¤ textarea åŸå§‹å€¼');
          }, 200);
        } else {
          console.log('[åˆå§‹åŒ–] æœªæ‰¾åˆ°èŠå¤©æ¡†å…ƒç´ ï¼ˆåœ¨iframeä¸­æ­£å¸¸ï¼‰ï¼Œè·³è¿‡æ–¹æ³•3');
        }
      }

      // æ–¹æ³•4ï¼šå‡å®šè„šæœ¬å·²è§¦å‘ï¼ˆå› ä¸º /xbqte æ˜¯å¼‚æ­¥çš„ï¼Œå¯èƒ½ä¸ä¼šç«‹å³è¿”å›ï¼‰
      if (!scriptTriggered) {
        console.log('[åˆå§‹åŒ–] executeSlash å¯èƒ½å·²å¼‚æ­¥è§¦å‘ï¼Œç›´æ¥è¿›å…¥ç­‰å¾…é˜¶æ®µ...');
        scriptTriggered = true; // å‡å®šå·²è§¦å‘ï¼Œè¿›å…¥è½®è¯¢æ£€æµ‹
      }

      // ç­‰å¾…è„šæœ¬æ‰§è¡Œå®Œæˆï¼ˆè½®è¯¢æ£€æµ‹ï¼‰
      console.log('[åˆå§‹åŒ–] ç­‰å¾…AIç”Ÿæˆ...');
      loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆæ”»ç•¥é…ç½®ï¼Œè¯·è€å¿ƒç­‰å¾…...';

      let attempts = 0;
      const maxAttempts = 120; // æœ€å¤šç­‰å¾…120ç§’
      let found = false;

      while (!found && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        attempts++;

        // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡å˜é‡
        if (attempts % 3 === 0) {
          try {
            const checkResult = await STscript('/getvar è¯Šç–—æ—¥è®°.çº¿ç´¢1.è§‚å¯Ÿè®°å½•', { abortSignal: null });

            let value = checkResult;

            // æå– pipe å­—æ®µ
            if (typeof checkResult === 'object' && checkResult !== null) {
              if (checkResult.pipe !== undefined) {
                value = checkResult.pipe;
              }
            }

            const valueStr = String(value || '');
            const trimmedLength = valueStr.trim().length;

            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆå­—ç¬¦ä¸²ï¼ˆéç©ºï¼‰
            if (typeof value === 'string' && trimmedLength > 0) {
              console.log('[åˆå§‹åŒ–] âœ… æ£€æµ‹åˆ°å˜é‡å·²å†™å…¥ï¼å†…å®¹é¢„è§ˆ:', value.substring(0, 50) + '...');
              found = true;
              break;
            }
            // ä¸å†è¾“å‡º"å˜é‡ä»ä¸ºç©º"çš„æ—¥å¿—ï¼Œå‡å°‘å™ªéŸ³
          } catch (e) {
            // é™é»˜å¤„ç†æ£€æŸ¥å¤±è´¥
          }
        }

        // æ¯10ç§’è¾“å‡ºä¸€æ¬¡æ—¥å¿—
        if (attempts % 10 === 0) {
          console.log(`[åˆå§‹åŒ–] ç­‰å¾…ä¸­... ${attempts}ç§’`);
        }
      }

      if (!found) {
        throw new Error(`åˆå§‹åŒ–è¶…æ—¶ï¼ˆ${attempts}ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥å°ç™½Xè„šæœ¬æ˜¯å¦æ­£ç¡®è¿è¡Œ`);
      }

      // åˆå§‹åŒ–å®Œæˆï¼Œéšè—å°é¢ï¼Œæ˜¾ç¤ºä¸»å†…å®¹ï¼ŒåŠ è½½å˜é‡
      console.log('[åˆå§‹åŒ–] å®Œæˆï¼æ˜¾ç¤ºè¯Šç–—æ—¥è®°...');
      hideCover();
      await loadDiaryFromVariables();
    } catch (e) {
      console.error('[åˆå§‹åŒ–] é”™è¯¯:', e);
      alert('âŒ åˆå§‹åŒ–å¤±è´¥: ' + e.message);
      button.disabled = false;
      loadingText.style.display = 'none';
    }
  }

  // éšè—å°é¢ï¼Œæ˜¾ç¤ºä¸»å†…å®¹
  function hideCover() {
    document.getElementById('yy-coverOverlay').classList.add('yy-hidden');
    document.getElementById('yy-mainContent').classList.remove('yy-hidden');
  }

  // æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
  async function checkInitialized() {
    // æ£€æŸ¥STscriptå‡½æ•°æ˜¯å¦å¯ç”¨
    if (typeof STscript !== 'function') return false;

    try {
      const result = await STscript('/getvar è¯Šç–—æ—¥è®°.çº¿ç´¢1.è§‚å¯Ÿè®°å½•', { abortSignal: null });

      console.log('[æ£€æŸ¥åˆå§‹åŒ–] åŸå§‹è¿”å›:', result, typeof result);

      let value = result;

      // å¤„ç†å¯¹è±¡è¿”å›å€¼
      if (typeof result === 'object' && result !== null) {
        if (result.pipe !== undefined) {
          value = result.pipe;
        } else {
          // ç©ºå¯¹è±¡è¯´æ˜å˜é‡ä¸å­˜åœ¨
          console.log('[æ£€æŸ¥åˆå§‹åŒ–] å˜é‡ä¸å­˜åœ¨ï¼ˆç©ºå¯¹è±¡ï¼‰');
          return false;
        }
      }

      // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆå­—ç¬¦ä¸²
      const isValid = typeof value === 'string' && value.trim().length > 0;
      console.log('[æ£€æŸ¥åˆå§‹åŒ–] ç»“æœ:', isValid, value?.substring(0, 50));

      return isValid;
    } catch (e) {
      console.error('[æ£€æŸ¥åˆå§‹åŒ–] é”™è¯¯:', e);
      return false;
    }
  }

  // æ£€æŸ¥æ˜¯å¦è·å¾—æ¯äº²åŒ»é™¢ç—…ä¾‹
  async function checkMedicalRecord() {
    if (typeof STscript !== 'function') return false;

    try {
      const result = await STscript('/xbgetvar ç—…ä¾‹.æ¯äº²åŒ»é™¢', { abortSignal: null });
      console.log('[ç—…ä¾‹æ£€æŸ¥] åŸå§‹è¿”å›:', result, typeof result);

      let hasRecord = false;

      // å¤„ç†ä¸åŒç±»å‹çš„è¿”å›å€¼
      if (typeof result === 'boolean') {
        hasRecord = result;
      } else if (typeof result === 'object' && result !== null) {
        if (result.pipe !== undefined) {
          hasRecord = result.pipe === true || result.pipe === 'true';
        }
      } else if (typeof result === 'string') {
        hasRecord = result.toLowerCase() === 'true';
      }

      console.log('[ç—…ä¾‹æ£€æŸ¥] æ˜¯å¦è·å¾—ç—…ä¾‹:', hasRecord);

      // æ§åˆ¶æŒ‰é’®æ˜¾ç¤º/éšè—
      const button = document.getElementById('yy-medicalRecordBtn');
      if (button) {
        button.style.display = hasRecord ? 'block' : 'none';
        console.log('[ç—…ä¾‹æ£€æŸ¥] æŒ‰é’®çŠ¶æ€:', hasRecord ? 'æ˜¾ç¤º' : 'éšè—');
      }

      return hasRecord;
    } catch (e) {
      console.error('[ç—…ä¾‹æ£€æŸ¥] é”™è¯¯:', e);
      return false;
    }
  }

  // æ˜¾ç¤ºNPCç”Ÿæˆå¼¹çª—
  function showNPCGenerationModal() {
    console.log('[NPCç”Ÿæˆ] æ˜¾ç¤ºç”Ÿæˆå¼¹çª—');
    const modal = document.getElementById('yyNPCGenModal');
    if (modal) {
      modal.classList.add('yy-show');
    } else {
      console.error('[NPCç”Ÿæˆ] æœªæ‰¾åˆ°å¼¹çª—å…ƒç´  #yyNPCGenModal');
    }
  }

  // éšè—NPCç”Ÿæˆå¼¹çª—
  function hideNPCGenModal() {
    const modal = document.getElementById('yyNPCGenModal');
    if (modal) {
      modal.classList.remove('yy-show');
    }
  }

  // NPCç”Ÿæˆå¤„ç†å‡½æ•°
  async function handleNPCGeneration() {
    const fetishInput = document.getElementById('yyNPCFetishInput').value.trim();
    const identityInput = document.getElementById('yyNPCIdentityInput').value.trim();

    console.log('[NPCç”Ÿæˆ] ç”¨æˆ·è¾“å…¥ - æ€§ç™–:', fetishInput);
    console.log('[NPCç”Ÿæˆ] ç”¨æˆ·è¾“å…¥ - èº«ä»½:', identityInput);

    if (!identityInput) {
      window.toastr && window.toastr.error('è¯·è¾“å…¥NPCçš„èº«ä»½/èŒä¸š');
      return;
    }

    // å…³é—­å¼¹çª—
    hideNPCGenModal();

    try {
      // æ£€æŸ¥STscriptå‡½æ•°æ˜¯å¦å¯ç”¨
      if (typeof STscript !== 'function') {
        throw new Error('STscriptå‡½æ•°ä¸å¯ç”¨');
      }

      // è®¾ç½®ä¸´æ—¶å˜é‡ï¼ˆä¼ é€’ç»™è„šæœ¬ï¼‰
      console.log('[NPCç”Ÿæˆ] 1/3 è®¾ç½®ä¸´æ—¶å˜é‡...');
      await STscript(`/setvar key=_temp_npc_fetishes ${fetishInput || ''}`);
      await STscript(`/setvar key=_temp_npc_identity ${identityInput}`);

      window.toastr && window.toastr.info('ğŸ¨ AIæ­£åœ¨ç”ŸæˆNPCï¼Œé¢„è®¡éœ€è¦60-120ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…...');

      // è°ƒç”¨"ç—…ä¾‹"è„šæœ¬
      console.log('[NPCç”Ÿæˆ] 2/3 è°ƒç”¨è„šæœ¬ï¼šç—…ä¾‹');

      let scriptTriggered = false;

      // æ–¹æ³•1ï¼šä½¿ç”¨å°ç™½Xçš„å…¨å±€å‡½æ•°
      if (typeof window.xbqte === 'function') {
        console.log('[NPCç”Ÿæˆ] ä½¿ç”¨ window.xbqte() è°ƒç”¨...');
        try {
          await window.xbqte('ç—…ä¾‹');
          scriptTriggered = true;
          console.log('[NPCç”Ÿæˆ] xbqte() è°ƒç”¨æˆåŠŸ');
        } catch (e) {
          console.error('[NPCç”Ÿæˆ] xbqte() è°ƒç”¨å¤±è´¥:', e);
        }
      }

      // æ–¹æ³•2ï¼šé€šè¿‡executeSlashè°ƒç”¨
      if (!scriptTriggered) {
        console.log('[NPCç”Ÿæˆ] å°è¯•é€šè¿‡ executeSlash è°ƒç”¨...');
        try {
          const executePromise = STscript('/xbqte ç—…ä¾‹', {
            handleExecutionErrors: false,
            abortSignal: null,
          });

          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('executeSlash è¶…æ—¶ï¼ˆ5ç§’ï¼‰')), 5000),
          );

          const result = await Promise.race([executePromise, timeoutPromise]);
          console.log('[NPCç”Ÿæˆ] executeSlash è¿”å›:', result);
          scriptTriggered = true;
        } catch (e) {
          console.log('[NPCç”Ÿæˆ] executeSlash æœªç«‹å³è¿”å›ï¼ˆæ­£å¸¸ï¼Œå¼‚æ­¥æ‰§è¡Œï¼‰');
          scriptTriggered = true; // å‡å®šå·²è§¦å‘
        }
      }

      // ç­‰å¾…ç”Ÿæˆå®Œæˆï¼ˆè½®è¯¢æ£€æµ‹NPCå˜é‡ï¼‰
      console.log('[NPCç”Ÿæˆ] 3/3 ç­‰å¾…AIç”Ÿæˆ...');

      let attempts = 0;
      const maxAttempts = 120; // æœ€å¤šç­‰å¾…120ç§’
      let found = false;

      while (!found && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        attempts++;

        // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
        if (attempts % 3 === 0) {
          try {
            const checkResult = await STscript('/xbgetvar NPCæ”»ç•¥.NPCæ•°æ®', { abortSignal: null });

            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„NPCæ•°æ®
            if (checkResult) {
              let npcData = {};

              if (typeof checkResult === 'object' && checkResult !== null) {
                if (checkResult.pipe !== undefined) {
                  const pipeValue = checkResult.pipe;
                  if (typeof pipeValue === 'string' && pipeValue.trim()) {
                    npcData = JSON.parse(pipeValue);
                  } else if (typeof pipeValue === 'object' && pipeValue !== null) {
                    npcData = pipeValue;
                  }
                } else {
                  npcData = checkResult;
                }
              } else if (typeof checkResult === 'string' && checkResult.trim()) {
                npcData = JSON.parse(checkResult);
              }

              const npcCount = Object.keys(npcData).length;

              if (npcCount > 0) {
                console.log('[NPCç”Ÿæˆ] âœ… æ£€æµ‹åˆ°NPCæ•°æ®ï¼Œæ•°é‡:', npcCount);
                found = true;
                break;
              }
            }
          } catch (e) {
            // é™é»˜å¤„ç†æ£€æŸ¥å¤±è´¥
          }
        }

        // æ¯10ç§’è¾“å‡ºä¸€æ¬¡æ—¥å¿—
        if (attempts % 10 === 0) {
          console.log(`[NPCç”Ÿæˆ] ç­‰å¾…ä¸­... ${attempts}ç§’`);
        }
      }

      if (!found) {
        throw new Error(`ç”Ÿæˆè¶…æ—¶ï¼ˆ${attempts}ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥è„šæœ¬æ˜¯å¦æ­£ç¡®è¿è¡Œ`);
      }

      // ç”Ÿæˆå®Œæˆ
      console.log('[NPCç”Ÿæˆ] å®Œæˆï¼');
      window.toastr && window.toastr.success('âœ… NPCç”Ÿæˆå®Œæˆï¼å¯åœ¨"è§’è‰²åˆ—è¡¨"ä¸­æŸ¥çœ‹');

      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById('yyNPCFetishInput').value = '';
      document.getElementById('yyNPCIdentityInput').value = 'å­¦æ ¡é‡Œçš„å­¦ç”Ÿ';

    } catch (e) {
      console.error('[NPCç”Ÿæˆ] é”™è¯¯:', e);
      window.toastr && window.toastr.error('âŒ ç”Ÿæˆå¤±è´¥: ' + e.message);
    }
  }

  // æ˜¾ç¤ºNPCåˆ—è¡¨å¼¹çª—
  async function showNPCListModal() {
    if (typeof STscript !== 'function') {
      window.toastr && window.toastr.error('STscriptä¸å¯ç”¨');
      return;
    }

    // åˆ›å»ºåŠ è½½ä¸­çš„æ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.className = 'yy-modal yy-show';
    modal.innerHTML = `
          <div class="yy-modal-content" style="max-width: 700px;">
            <div class="yy-modal-header">
              <h3>ğŸ‘¥ è§’è‰²åˆ—è¡¨</h3>
            </div>
            <div class="yy-modal-body" id="yy-npc-modal-body" style="max-height: 500px; overflow-y: auto; line-height: 1.8;">
              <div style="text-align: center; padding: 40px; color: var(--accent);">
                <div style="font-size: 32px; margin-bottom: 16px;">â³</div>
                <div>æ­£åœ¨åŠ è½½è§’è‰²æ•°æ®...</div>
              </div>
            </div>
            <div class="yy-modal-footer">
              <button class="yy-modal-btn yy-btn-confirm" onclick="this.closest('.yy-modal').remove()">
                å…³é—­
              </button>
            </div>
          </div>
        `;

    document.body.appendChild(modal);

    // ç‚¹å‡»é®ç½©å…³é—­
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.remove();
      }
    });

    // å¼‚æ­¥åŠ è½½NPCæ•°æ®
    try {
      console.log('[NPCåˆ—è¡¨] å¼€å§‹åŠ è½½NPCæ•°æ®...');
      const result = await STscript('/xbgetvar NPCæ”»ç•¥.NPCæ•°æ®', { abortSignal: null });
      console.log('[NPCåˆ—è¡¨] åŸå§‹è¿”å›:', result);

      let npcData = {};

      // è§£æè¿”å›å€¼
      if (typeof result === 'object' && result !== null) {
        if (result.pipe !== undefined) {
          const pipeValue = result.pipe;
          if (typeof pipeValue === 'string' && pipeValue.trim()) {
            npcData = JSON.parse(pipeValue);
          } else if (typeof pipeValue === 'object' && pipeValue !== null) {
            npcData = pipeValue;
          }
        } else {
          npcData = result;
        }
      } else if (typeof result === 'string' && result.trim()) {
        npcData = JSON.parse(result);
      }

      console.log('[NPCåˆ—è¡¨] è§£æåçš„NPCæ•°æ®:', npcData);

      const npcNames = Object.keys(npcData);
      console.log('[NPCåˆ—è¡¨] NPCæ•°é‡:', npcNames.length);

      const modalBody = document.getElementById('yy-npc-modal-body');

      if (npcNames.length === 0) {
        modalBody.innerHTML = `
              <div style="text-align: center; padding: 40px; color: rgba(90, 70, 53, 0.6);">
                <div style="font-size: 32px; margin-bottom: 16px;">ğŸ“­</div>
                <div>æš‚æ— è§’è‰²æ•°æ®</div>
                <div style="font-size: 13px; margin-top: 8px;">è¯·å…ˆç”ŸæˆNPC</div>
              </div>
            `;
        return;
      }

      // æ„å»ºNPCåˆ—è¡¨HTML
      let html = '';

      for (let i = 0; i < npcNames.length; i++) {
        const npcName = npcNames[i];
        const scenes = npcData[npcName];

        console.log(`[NPCåˆ—è¡¨] å¤„ç†NPC: ${npcName}, åœºæ™¯æ•°æ®:`, scenes);

        // ç»Ÿè®¡è§£é”æƒ…å†µï¼ˆæ”¯æŒå¤æ‚å¯¹è±¡ç»“æ„ï¼‰
        const sceneKeys = Object.keys(scenes);
        const completedCount = sceneKeys.filter(key => {
          const scene = scenes[key];
          return typeof scene === 'object' && scene !== null && scene.unlocked === "completed";
        }).length;
        const totalCount = sceneKeys.length;

        // åˆ¤æ–­æƒ…æ„Ÿé˜¶æ®µï¼ˆåŸºäºcompletedåœºæ™¯æ•°é‡ï¼‰
        let emotionalStage = '';
        let stageColor = '';
        if (completedCount >= 0 && completedCount <= 2) {
          emotionalStage = 'çº¯è‚‰æ¬²æœŸ';
          stageColor = '#999';
        } else if (completedCount >= 3 && completedCount <= 4) {
          emotionalStage = 'å¼€å§‹åœ¨ä¹';
          stageColor = '#f0c864';
        } else if (completedCount === 5) {
          emotionalStage = 'æƒ…æ„Ÿä¾èµ–';
          stageColor = '#f08c50';
        } else if (completedCount >= 6) {
          emotionalStage = 'æ·±åº¦ç¾ç»Š';
          stageColor = '#64b478';
        }

        html += `
              <div style="margin-bottom: 24px; padding: 16px; background: rgba(255, 255, 255, 0.5); border: 1px solid var(--border); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                  <h4 style="margin: 0; color: var(--ink); font-size: 16px;">ğŸ’ƒ ${npcName}</h4>
                  <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${stageColor}22; color: ${stageColor};">
                    ${emotionalStage}
                  </span>
                </div>

                <div style="margin-bottom: 8px; font-size: 13px; color: var(--accent); font-weight: 600;">
                  åœºæ™¯è¿›åº¦ï¼š${completedCount} / ${totalCount} å·²å®Œæˆ
                </div>

                <div style="background: rgba(0,0,0,0.05); border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 12px;">
                  <div style="height: 100%; background: linear-gradient(90deg, ${stageColor}, ${stageColor}dd); width: ${(completedCount / totalCount * 100).toFixed(1)}%; transition: width 0.3s;"></div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
            `;

        // éå†åœºæ™¯ï¼ˆæ”¯æŒå¤æ‚å¯¹è±¡ç»“æ„å’ŒåŠ¨æ€åç§°ï¼‰
        sceneKeys.forEach((sceneKey, index) => {
          const scene = scenes[sceneKey];
          let icon, bgColor, textColor, statusText;

          if (typeof scene === 'object' && scene !== null) {
            // å¤æ‚å¯¹è±¡ç»“æ„
            const status = scene.unlocked;
            const sceneName = scene.name || `åœºæ™¯${index + 1}`;
            const intensity = scene.intensity || '';

            switch (status) {
              case "active":
                icon = 'ğŸ”¥';
                bgColor = 'rgba(240, 200, 100, 0.15)';
                textColor = '#c86400';
                statusText = 'è¿›è¡Œä¸­';
                break;
              case "completed":
                icon = 'âœ…';
                bgColor = 'rgba(100, 180, 120, 0.15)';
                textColor = '#2d8659';
                statusText = 'å·²å®Œæˆ';
                break;
              default: // locked
                icon = 'ğŸ”’';
                bgColor = 'rgba(0, 0, 0, 0.05)';
                textColor = 'rgba(90, 70, 53, 0.5)';
                statusText = 'æœªè§£é”';
            }

            html += `
                  <div onclick="showSceneControl('${npcName}', '${sceneKey}')"
                       style="padding: 8px 10px; background: ${bgColor}; border-radius: 4px; font-size: 12px; color: ${textColor}; text-align: center; border: 1px solid ${status === 'active' ? 'rgba(240, 200, 100, 0.3)' : 'transparent'}; cursor: pointer; transition: all 0.2s;"
                       onmouseover="this.style.borderColor='${status === 'active' ? 'rgba(240, 200, 100, 0.5)' : 'rgba(90, 70, 53, 0.3)'}'; this.style.transform='translateY(-1px)'"
                       onmouseout="this.style.borderColor='${status === 'active' ? 'rgba(240, 200, 100, 0.3)' : 'transparent'}'; this.style.transform='translateY(0px)'">
                    <div style="font-weight: 600; margin-bottom: 2px;">${icon} ${sceneName}</div>
                    <div style="font-size: 10px; opacity: 0.8;">${intensity} Â· ${statusText}</div>
                    <div style="font-size: 9px; opacity: 0.6; margin-top: 2px;">ç‚¹å‡»æ§åˆ¶</div>
                  </div>
                `;
          } else {
            // å…¼å®¹æ—§ç‰ˆå¸ƒå°”å€¼ç»“æ„
            const isUnlocked = scenes[sceneKey] === true;
            icon = isUnlocked ? 'âœ…' : 'ğŸ”’';
            bgColor = isUnlocked ? 'rgba(100, 180, 120, 0.15)' : 'rgba(0, 0, 0, 0.05)';
            textColor = isUnlocked ? '#2d8659' : 'rgba(90, 70, 53, 0.5)';

            html += `
                  <div style="padding: 8px 10px; background: ${bgColor}; border-radius: 4px; font-size: 12px; color: ${textColor}; text-align: center;">
                    ${icon} åœºæ™¯${index + 1}
                  </div>
                `;
          }
        });

        html += `
                </div>
              </div>
            `;
      }

      modalBody.innerHTML = html;
      console.log('[NPCåˆ—è¡¨] æ¸²æŸ“å®Œæˆ');
    } catch (e) {
      console.error('[NPCåˆ—è¡¨] åŠ è½½å¤±è´¥:', e);
      const modalBody = document.getElementById('yy-npc-modal-body');
      if (modalBody) {
        modalBody.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #c83232;">
                <div style="font-size: 32px; margin-bottom: 16px;">âŒ</div>
                <div>åŠ è½½å¤±è´¥</div>
                <div style="font-size: 13px; margin-top: 8px;">${e.message}</div>
              </div>
            `;
      }
    }
  }

  setTimeout( async function () {
    var buttons = document.querySelectorAll('.yy-page-btn');
    buttons.forEach(function (button) {
      button.addEventListener('click', function () {
        var pageNum = Number(this.dataset.page);
        showPage(pageNum);
      });
    });

    // ç»‘å®šå°é¢åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
    var initButton = document.getElementById('yy-initButton');
    console.log('[åˆå§‹åŒ–å¼¹çª—] å°é¢æŒ‰é’®å…ƒç´ :', initButton);
    if (initButton) {
      initButton.addEventListener('click', function () {
        console.log('[åˆå§‹åŒ–å¼¹çª—] æŒ‰é’®è¢«ç‚¹å‡»');
        showInitModal();
      });
      console.log('[åˆå§‹åŒ–å¼¹çª—] äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
    } else {
      console.error('[åˆå§‹åŒ–å¼¹çª—] æœªæ‰¾åˆ°å°é¢æŒ‰é’®å…ƒç´  #yy-initButton');
    }

    // æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
    const initialized = await checkInitialized();

    if (initialized) {
      // å·²åˆå§‹åŒ–ï¼Œç›´æ¥æ˜¾ç¤ºä¸»å†…å®¹
      hideCover();
      loadDiaryFromVariables();

      // æ£€æŸ¥ç—…ä¾‹çŠ¶æ€
      await checkMedicalRecord();

      // å®šæœŸæ£€æŸ¥ç—…ä¾‹çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
      setInterval(checkMedicalRecord, 30000);

      // ç›‘å¬èŠå¤©æ¶ˆæ¯å˜åŒ–ï¼Œå®æ—¶æ£€æµ‹ç—…ä¾‹è·å¾—
      const chatContainer = document.querySelector('#chat');
      if (chatContainer) {
        const observer = new MutationObserver(function() {
          setTimeout(checkMedicalRecord, 1000);
        });
        observer.observe(chatContainer, { childList: true, subtree: true });
      }
    } else {
      // æœªåˆå§‹åŒ–ï¼Œæ˜¾ç¤ºå°é¢
      console.log('[è¯Šç–—æ—¥è®°] ç­‰å¾…åˆå§‹åŒ–');
    }

    // ç»‘å®š"æ¢ç´¢ç—…ä¾‹"æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆæ”¹ä¸ºNPCç”ŸæˆåŠŸèƒ½ï¼‰
    const medicalRecordBtn = document.getElementById('yy-medicalRecordBtn');
    if (medicalRecordBtn) {
      medicalRecordBtn.addEventListener('click', showNPCGenerationModal);
      console.log('[æ¢ç´¢ç—…ä¾‹] æŒ‰é’®äº‹ä»¶å·²ç»‘å®š â†’ NPCç”ŸæˆåŠŸèƒ½');
    }

    // ç»‘å®šNPCç”Ÿæˆå¼¹çª—çš„æŒ‰é’®äº‹ä»¶
    const npcGenCancel = document.getElementById('yyNPCGenCancel');
    if (npcGenCancel) {
      npcGenCancel.addEventListener('click', hideNPCGenModal);
    }

    const npcGenConfirm = document.getElementById('yyNPCGenConfirm');
    if (npcGenConfirm) {
      npcGenConfirm.addEventListener('click', handleNPCGeneration);
    }

    // ç‚¹å‡»é®ç½©å±‚å…³é—­NPCç”Ÿæˆå¼¹çª—
    const npcGenModal = document.getElementById('yyNPCGenModal');
    if (npcGenModal) {
      npcGenModal.addEventListener('click', function (e) {
        if (e.target === npcGenModal) {
          hideNPCGenModal();
        }
      });
    }

    // ç»‘å®š"è§’è‰²åˆ—è¡¨"æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const npcListBtn = document.getElementById('yy-npcListBtn');
    if (npcListBtn) {
      npcListBtn.addEventListener('click', showNPCListModal);
      console.log('[è§’è‰²åˆ—è¡¨] æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    }
  },200);

  // ============================================================
  // æ”»ç•¥è¿›åº¦é¢æ¿åŠŸèƒ½
  // ============================================================

  var currentStrategyPage = 1; // å½“å‰æ”»ç•¥é¡µï¼ˆè·Ÿéšæ—¥è®°ç¿»é¡µï¼‰

  // åˆ‡æ¢æ”»ç•¥é¢æ¿å±•å¼€/æ”¶èµ·
  document.getElementById('yyStrategyToggle').addEventListener('click', function () {
    var panel = document.getElementById('yyStrategyPanel');
    var toggle = document.getElementById('yyStrategyToggle');

    if (panel.classList.contains('yy-expanded')) {
      panel.classList.remove('yy-expanded');
      toggle.classList.remove('yy-expanded');
    } else {
      panel.classList.add('yy-expanded');
      toggle.classList.add('yy-expanded');
      // å±•å¼€æ—¶åŠ è½½å½“å‰é¡µçš„äº‹ä»¶
      loadCurrentClueEvents();
    }
  });

  // åŠ è½½å½“å‰çº¿ç´¢çš„äº‹ä»¶
  async function loadCurrentClueEvents() {
    var clueNum = currentStrategyPage;
    var container = document.getElementById('yyEventsContainer');
    container.innerHTML = '<div class="yy-loading">æ­£åœ¨åŠ è½½...</div>';

    try {
      var result = await STscript('/xbgetvar æ”»ç•¥.äº‹ä»¶.çº¿ç´¢' + clueNum, {
        handleExecutionErrors: false,
        handleParserErrors: false,
      });

      // ========== è°ƒè¯•æ—¥å¿—å¼€å§‹ ==========
      console.log('=== [æ”»ç•¥è¿›åº¦] è°ƒè¯•ä¿¡æ¯ ===');
      console.log('å½“å‰çº¿ç´¢ç¼–å·:', clueNum);
      console.log('åŸå§‹è¿”å›å€¼ (result):', result);
      console.log('è¿”å›å€¼ç±»å‹:', typeof result);
      console.log('è¿”å›å€¼æ˜¯å¦ä¸ºnull:', result === null);
      console.log('è¿”å›å€¼æ˜¯å¦ä¸ºundefined:', result === undefined);
      if (result && typeof result === 'object') {
        console.log('è¿”å›å€¼çš„keys:', Object.keys(result));
        console.log('æ˜¯å¦æœ‰pipeå­—æ®µ:', 'pipe' in result);
        if ('pipe' in result) {
          console.log('pipeå€¼:', result.pipe);
          console.log('pipeç±»å‹:', typeof result.pipe);
        }
      }
      console.log('========================');
      // ========== è°ƒè¯•æ—¥å¿—ç»“æŸ ==========

      var valueRaw = result || {};
      var events = {};

      // è§£æå˜é‡å€¼
      if (typeof valueRaw === 'object' && valueRaw.pipe !== undefined) {
        // æƒ…å†µ1ï¼šæœ‰pipeå­—æ®µ
        var pipeValue = valueRaw.pipe;
        console.log('[æ”»ç•¥è¿›åº¦] ä½¿ç”¨pipeå€¼, pipeç±»å‹:', typeof pipeValue);

        if (typeof pipeValue === 'string' && pipeValue.trim()) {
          try {
            events = JSON.parse(pipeValue);
            console.log('[æ”»ç•¥è¿›åº¦] pipeå­—ç¬¦ä¸²è§£ææˆåŠŸ, events:', events);
          } catch (e) {
            console.error('[æ”»ç•¥è¿›åº¦] pipeå­—ç¬¦ä¸²è§£æå¤±è´¥:', e);
          }
        } else if (typeof pipeValue === 'object' && pipeValue !== null) {
          events = pipeValue;
          console.log('[æ”»ç•¥è¿›åº¦] pipeæ˜¯å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨, events:', events);
        }
      } else if (typeof valueRaw === 'string' && valueRaw.trim()) {
        // æƒ…å†µ2ï¼šå­—ç¬¦ä¸²
        console.log('[æ”»ç•¥è¿›åº¦] ä½¿ç”¨å­—ç¬¦ä¸²å€¼, é•¿åº¦:', valueRaw.length);
        try {
          events = JSON.parse(valueRaw);
          console.log('[æ”»ç•¥è¿›åº¦] å­—ç¬¦ä¸²è§£ææˆåŠŸ, events:', events);
        } catch (e) {
          console.error('[æ”»ç•¥è¿›åº¦] å­—ç¬¦ä¸²è§£æå¤±è´¥:', e);
        }
      } else if (typeof valueRaw === 'object' && valueRaw !== null && !valueRaw.pipe) {
        // æƒ…å†µ3ï¼šç›´æ¥è¿”å›çš„å¯¹è±¡ï¼ˆæ²¡æœ‰pipeå­—æ®µï¼‰
        events = valueRaw;
        console.log('[æ”»ç•¥è¿›åº¦] ç›´æ¥ä½¿ç”¨è¿”å›çš„å¯¹è±¡, events:', events);
      } else {
        console.log('[æ”»ç•¥è¿›åº¦] æœªåŒ¹é…åˆ°ä»»ä½•è§£æåˆ†æ”¯');
      }

      var eventCount = Object.keys(events).length;
      console.log('[æ”»ç•¥è¿›åº¦] äº‹ä»¶æ•°é‡:', eventCount);

      // åˆ¤æ–­é˜¶æ®µ
      var stage = '';
      var stageClass = '';
      if (eventCount <= 2) {
        stage = 'æŠ—æ‹’æœŸ';
        stageClass = 'yy-stage-1';
      } else if (eventCount <= 5) {
        stage = 'åŠ¨æ‘‡æœŸ';
        stageClass = 'yy-stage-2';
      } else if (eventCount <= 10) {
        stage = 'çªç ´æœŸ';
        stageClass = 'yy-stage-3';
      } else {
        stage = 'æ¥å—æœŸ';
        stageClass = 'yy-stage-4';
      }

      // æ›´æ–°é˜¶æ®µæ˜¾ç¤ºï¼ˆæŒ‰é’®å³ä¾§ï¼‰
      var stageEl = document.getElementById('yyCurrentStage');
      stageEl.textContent = stage;
      stageEl.className = 'yy-current-stage ' + stageClass;

      // æ›´æ–°äº‹ä»¶åˆ—è¡¨
      if (eventCount === 0) {
        container.innerHTML = '<div class="yy-loading">æš‚æ— äº‹ä»¶è®°å½•</div>';
      } else {
        var html = '';
        var keys = Object.keys(events);
        keys.sort();

        for (var i = 0; i < keys.length; i++) {
          var key = keys[i];
          var value = events[key];
          html += '<div class="yy-event-item">';
          html += '<span class="yy-event-key">' + key + '</span>';
          html += '<span>' + value + '</span>';
          html += '</div>';
        }

        container.innerHTML = html;
      }

      console.log('[æ”»ç•¥è¿›åº¦] çº¿ç´¢' + clueNum + ' åŠ è½½å®Œæˆ:', eventCount + 'ä¸ªäº‹ä»¶,', stage);
    } catch (e) {
      console.error('[æ”»ç•¥è¿›åº¦] åŠ è½½å¤±è´¥:', e);
      container.innerHTML = '<div class="yy-loading" style="color: #c83232;">åŠ è½½å¤±è´¥</div>';
    }
  }

  // åˆå§‹åŠ è½½å½“å‰é¡µçš„æ”»ç•¥é˜¶æ®µï¼ˆåªæ›´æ–°é˜¶æ®µæ ‡ç­¾ï¼Œä¸åŠ è½½äº‹ä»¶ï¼‰
  async function updateCurrentStage() {
    var clueNum = currentStrategyPage;

    try {
      var result = await STscript('/xbgetvar æ”»ç•¥.äº‹ä»¶.çº¿ç´¢' + clueNum, {
        handleExecutionErrors: false,
        handleParserErrors: false,
      });

      // ========== è°ƒè¯•æ—¥å¿—å¼€å§‹ ==========
      console.log('=== [æ›´æ–°é˜¶æ®µ] è°ƒè¯•ä¿¡æ¯ ===');
      console.log('å½“å‰çº¿ç´¢ç¼–å·:', clueNum);
      console.log('åŸå§‹è¿”å›å€¼ (result):', result);
      console.log('è¿”å›å€¼ç±»å‹:', typeof result);
      if (result && typeof result === 'object') {
        console.log('è¿”å›å€¼çš„keys:', Object.keys(result));
        console.log('æ˜¯å¦æœ‰pipeå­—æ®µ:', 'pipe' in result);
        if ('pipe' in result) {
          console.log('pipeå€¼:', result.pipe);
          console.log('pipeç±»å‹:', typeof result.pipe);
        }
      }
      console.log('========================');
      // ========== è°ƒè¯•æ—¥å¿—ç»“æŸ ==========

      var valueRaw = result || {};
      var events = {};

      // è§£æå˜é‡å€¼
      if (typeof valueRaw === 'object' && valueRaw.pipe !== undefined) {
        // æƒ…å†µ1ï¼šæœ‰pipeå­—æ®µ
        var pipeValue = valueRaw.pipe;
        console.log('[æ›´æ–°é˜¶æ®µ] ä½¿ç”¨pipeå€¼, pipeç±»å‹:', typeof pipeValue);

        if (typeof pipeValue === 'string' && pipeValue.trim()) {
          try {
            events = JSON.parse(pipeValue);
            console.log('[æ›´æ–°é˜¶æ®µ] pipeå­—ç¬¦ä¸²è§£ææˆåŠŸ, events:', events);
          } catch (e) {
            console.log('[æ›´æ–°é˜¶æ®µ] pipeå­—ç¬¦ä¸²è§£æå¤±è´¥:', e);
          }
        } else if (typeof pipeValue === 'object' && pipeValue !== null) {
          events = pipeValue;
          console.log('[æ›´æ–°é˜¶æ®µ] pipeæ˜¯å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨, events:', events);
        }
      } else if (typeof valueRaw === 'string' && valueRaw.trim()) {
        // æƒ…å†µ2ï¼šå­—ç¬¦ä¸²
        console.log('[æ›´æ–°é˜¶æ®µ] ä½¿ç”¨å­—ç¬¦ä¸²å€¼, é•¿åº¦:', valueRaw.length);
        try {
          events = JSON.parse(valueRaw);
          console.log('[æ›´æ–°é˜¶æ®µ] å­—ç¬¦ä¸²è§£ææˆåŠŸ, events:', events);
        } catch (e) {
          console.log('[æ›´æ–°é˜¶æ®µ] å­—ç¬¦ä¸²è§£æå¤±è´¥:', e);
        }
      } else if (typeof valueRaw === 'object' && valueRaw !== null && !valueRaw.pipe) {
        // æƒ…å†µ3ï¼šç›´æ¥è¿”å›çš„å¯¹è±¡ï¼ˆæ²¡æœ‰pipeå­—æ®µï¼‰
        events = valueRaw;
        console.log('[æ›´æ–°é˜¶æ®µ] ç›´æ¥ä½¿ç”¨è¿”å›çš„å¯¹è±¡, events:', events);
      } else {
        console.log('[æ›´æ–°é˜¶æ®µ] æœªåŒ¹é…åˆ°ä»»ä½•è§£æåˆ†æ”¯');
      }

      var eventCount = Object.keys(events).length;
      console.log('[æ›´æ–°é˜¶æ®µ] äº‹ä»¶æ•°é‡:', eventCount);

      var stage = '';
      var stageClass = '';
      if (eventCount <= 2) {
        stage = 'æŠ—æ‹’æœŸ';
        stageClass = 'yy-stage-1';
      } else if (eventCount <= 5) {
        stage = 'åŠ¨æ‘‡æœŸ';
        stageClass = 'yy-stage-2';
      } else if (eventCount <= 10) {
        stage = 'çªç ´æœŸ';
        stageClass = 'yy-stage-3';
      } else {
        stage = 'æ¥å—æœŸ';
        stageClass = 'yy-stage-4';
      }

      var stageEl = document.getElementById('yyCurrentStage');
      stageEl.textContent = stage;
      stageEl.className = 'yy-current-stage ' + stageClass;
    } catch (e) {
      console.error('[æ”»ç•¥è¿›åº¦] æ›´æ–°é˜¶æ®µå¤±è´¥:', e);
    }
  }

  // åˆå§‹åŠ è½½é˜¶æ®µ
  updateCurrentStage();

  console.log('[æ”»ç•¥è¿›åº¦] åŠŸèƒ½å·²åˆå§‹åŒ–');

  // ============================================================
  // ç¾åŒ–åˆå§‹åŒ–å¼¹çª—
  // ============================================================

  // æ˜¾ç¤ºå¼¹çª—
  function showInitModal() {
    console.log('[åˆå§‹åŒ–å¼¹çª—] showInitModal è¢«è°ƒç”¨');
    var modal = document.getElementById('yyInitModal');
    console.log('[åˆå§‹åŒ–å¼¹çª—] å¼¹çª—å…ƒç´ :', modal);
    if (modal) {
      modal.classList.add('yy-show');
      console.log('[åˆå§‹åŒ–å¼¹çª—] å·²æ·»åŠ  yy-show ç±»');
    } else {
      console.error('[åˆå§‹åŒ–å¼¹çª—] æœªæ‰¾åˆ°å¼¹çª—å…ƒç´  #yyInitModal');
    }
  }

  // éšè—å¼¹çª—
  function hideInitModal() {
    var modal = document.getElementById('yyInitModal');
    modal.classList.remove('yy-show');
  }

  // å–æ¶ˆæŒ‰é’®
  document.getElementById('yyInitCancel').addEventListener('click', function () {
    hideInitModal();
  });

  // ç¡®è®¤åˆå§‹åŒ–æŒ‰é’®
  document.getElementById('yyInitConfirm').addEventListener('click', function () {
    hideInitModal();
    handleInitialize();
  });

  // ç‚¹å‡»é®ç½©å±‚å…³é—­
  document.getElementById('yyInitModal').addEventListener('click', function (e) {
    if (e.target === this) {
      hideInitModal();
    }
  });

  console.log('[åˆå§‹åŒ–å¼¹çª—] åŠŸèƒ½å·²åˆå§‹åŒ–');

  // åœºæ™¯æ§åˆ¶å¼¹çª—å‡½æ•°
  async function showSceneControl(npcName, sceneKey) {
    try {
      console.log(`[åœºæ™¯æ§åˆ¶] æ‰“å¼€ ${npcName}.${sceneKey} æ§åˆ¶é¢æ¿`);

      // è·å–åœºæ™¯å®Œæ•´æ•°æ®
      const result = await STscript(`/xbgetvar NPCæ”»ç•¥.NPCæ•°æ®.${npcName}.${sceneKey}`);
      let sceneData;
      if (typeof result === 'object' && result !== null) {
        if (result.pipe !== undefined) {
          sceneData = typeof result.pipe === 'string' ? JSON.parse(result.pipe) : result.pipe;
        } else {
          sceneData = result;
        }
      } else if (typeof result === 'string') {
        sceneData = JSON.parse(result);
      }

      // çŠ¶æ€å›¾æ ‡å’Œæ–‡æœ¬
      const getStatusInfo = (status) => {
        switch (status) {
          case "active": return { icon: 'ğŸ”¥', text: 'è¿›è¡Œä¸­' };
          case "completed": return { icon: 'âœ…', text: 'å·²å®Œæˆ' };
          default: return { icon: 'ğŸ”’', text: 'æœªè§£é”' };
        }
      };

      const statusInfo = getStatusInfo(sceneData.unlocked);

      // åˆ›å»ºå¼¹çª—
      const modal = document.createElement('div');
      modal.className = 'yy-modal yy-show';
      modal.innerHTML = `
          <div class="yy-modal-content" style="max-width: 400px;">
            <div class="yy-modal-header">
              <h3>${statusInfo.icon} ${sceneData.name}</h3>
              <button onclick="this.closest('.yy-modal').remove()" style="background: none; border: none; font-size: 18px; cursor: pointer;">Ã—</button>
            </div>
            <div class="yy-modal-body" style="line-height: 1.6;">
              <div style="margin-bottom: 16px; padding: 12px; background: rgba(0,0,0,0.05); border-radius: 6px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: var(--ink);">åœºæ™¯ä¿¡æ¯ï¼š</div>
                <div style="font-size: 14px; color: var(--accent);">
                  â€¢ å¼ºåº¦ï¼š${sceneData.intensity || 'æœªçŸ¥'}<br>
                  â€¢ çŠ¶æ€ï¼š${statusInfo.text}
                </div>
              </div>

              <div style="margin-bottom: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: var(--ink);">æ“ä½œæ§åˆ¶ï¼š</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                  <button onclick="resetScene('${npcName}', '${sceneKey}')"
                          style="padding: 8px 12px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                    ğŸ”’ é‡ç½®ä¸ºæœªè§£é”
                  </button>
                  <button onclick="completeScene('${npcName}', '${sceneKey}')"
                          style="padding: 8px 12px; background: #2d8659; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                    âœ… æ ‡è®°ä¸ºå®Œæˆ
                  </button>
                  <button onclick="startScene('${npcName}', '${sceneKey}')"
                          style="padding: 8px 12px; background: #c86400; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                    ğŸ”¥ åœºæ™¯å¼€å§‹
                  </button>
                  <button onclick="copySceneId('${sceneKey}')"
                          style="padding: 8px 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                    ğŸ“‹ å¤åˆ¶åœºæ™¯ID
                  </button>
                </div>
              </div>
            </div>
            <div class="yy-modal-footer">
              <button class="yy-modal-btn yy-btn-confirm" onclick="this.closest('.yy-modal').remove()">
                å…³é—­
              </button>
            </div>
          </div>
        `;

      document.body.appendChild(modal);

      // ç‚¹å‡»é®ç½©å…³é—­
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });

    } catch (e) {
      console.error('[åœºæ™¯æ§åˆ¶] å¼¹çª—æ‰“å¼€å¤±è´¥:', e);
      window.toastr && window.toastr.error('æ— æ³•æ‰“å¼€åœºæ™¯æ§åˆ¶é¢æ¿');
    }
  }

  // åœºæ™¯æ“ä½œå‡½æ•°
  async function resetScene(npcName, sceneKey) {
    try {
      console.log(`[åœºæ™¯æ§åˆ¶] é‡ç½®åœºæ™¯: ${npcName}.${sceneKey}`);

      // è·å–å½“å‰æ•°æ®
      const result = await STscript(`/xbgetvar NPCæ”»ç•¥.NPCæ•°æ®.${npcName}.${sceneKey}`);
      let sceneData = typeof result === 'string' ? JSON.parse(result) : result;

      // é‡ç½®ä¸ºæœªè§£é”
      sceneData.unlocked = "locked";

      // ä¿å­˜æ•°æ®
      await STscript(`/xbsetvar key=NPCæ”»ç•¥.NPCæ•°æ®.${npcName}.${sceneKey} ${JSON.stringify(sceneData)}`);

      // å…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨
      document.querySelector('.yy-modal').remove();
      showNPCList(); // åˆ·æ–°NPCåˆ—è¡¨

      window.toastr && window.toastr.success(`âœ… ${sceneData.name} å·²é‡ç½®ä¸ºæœªè§£é”`);
    } catch (e) {
      console.error('[åœºæ™¯æ§åˆ¶] é‡ç½®å¤±è´¥:', e);
      window.toastr && window.toastr.error('é‡ç½®æ“ä½œå¤±è´¥');
    }
  }

  async function completeScene(npcName, sceneKey) {
    try {
      console.log(`[åœºæ™¯æ§åˆ¶] å®Œæˆåœºæ™¯: ${npcName}.${sceneKey}`);

      // è·å–å½“å‰æ•°æ®
      const result = await STscript(`/xbgetvar NPCæ”»ç•¥.NPCæ•°æ®.${npcName}.${sceneKey}`);
      let sceneData = typeof result === 'string' ? JSON.parse(result) : result;

      // æ ‡è®°ä¸ºå®Œæˆ
      sceneData.unlocked = "completed";

      // ä¿å­˜æ•°æ®
      await STscript(`/xbsetvar key=NPCæ”»ç•¥.NPCæ•°æ®.${npcName}.${sceneKey} ${JSON.stringify(sceneData)}`);

      // å…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨
      document.querySelector('.yy-modal').remove();
      showNPCList(); // åˆ·æ–°NPCåˆ—è¡¨

      window.toastr && window.toastr.success(`âœ… ${sceneData.name} å·²æ ‡è®°ä¸ºå®Œæˆ`);
    } catch (e) {
      console.error('[åœºæ™¯æ§åˆ¶] å®Œæˆå¤±è´¥:', e);
      window.toastr && window.toastr.error('å®Œæˆæ“ä½œå¤±è´¥');
    }
  }

  async function startScene(npcName, sceneKey) {
    try {
      console.log(`[åœºæ™¯æ§åˆ¶] å¼€å§‹åœºæ™¯: ${npcName}.${sceneKey}`);

      // è·å–å½“å‰æ•°æ®
      const result = await STscript(`/xbgetvar NPCæ”»ç•¥.NPCæ•°æ®.${npcName}.${sceneKey}`);
      let sceneData = typeof result === 'string' ? JSON.parse(result) : result;

      // è®¾ç½®ä¸ºè¿›è¡Œä¸­
      sceneData.unlocked = "active";

      // ä¿å­˜æ•°æ®
      await STscript(`/xbsetvar key=NPCæ”»ç•¥.NPCæ•°æ®.${npcName}.${sceneKey} ${JSON.stringify(sceneData)}`);

      // å…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨
      document.querySelector('.yy-modal').remove();
      showNPCList(); // åˆ·æ–°NPCåˆ—è¡¨

      window.toastr && window.toastr.success(`ğŸ”¥ ${sceneData.name} å·²å¼€å§‹`);
    } catch (e) {
      console.error('[åœºæ™¯æ§åˆ¶] å¼€å§‹å¤±è´¥:', e);
      window.toastr && window.toastr.error('å¼€å§‹æ“ä½œå¤±è´¥');
    }
  }

  async function copySceneId(sceneKey) {
    try {
      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      await navigator.clipboard.writeText(sceneKey);
      window.toastr && window.toastr.success(`ğŸ“‹ åœºæ™¯IDå·²å¤åˆ¶: ${sceneKey}`);
    } catch (e) {
      console.error('[åœºæ™¯æ§åˆ¶] å¤åˆ¶å¤±è´¥:', e);
      window.toastr && window.toastr.error('å¤åˆ¶å¤±è´¥');
    }
  }

</script>
</body>
</html>
